# Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
# SPDX-License-Identifier: Apache-2.0

# This workflow tests the TLS configuration of the smithy-rs client

env:
  rust_version: 1.68.2

name: Verify client TLS configuration
on:
  pull_request:

jobs:
  verify-tls-config:
    name: Verify TLS configuration
    runs-on: ubuntu-latest
    steps:
      - name: Install packages
        shell: bash
        run: |
          sudo apt -y install gcc make python3-pip nginx git
          pip3 install certbuilder crlbuilder
      - name: Checkout smithy-rs
        uses: actions/checkout@v3
        with:
          path: ./smithy-rs
      - name: Checkout trytls
        uses: actions/checkout@v3
        with:
          repository: ouspg/trytls
          path: ./trytls
      - name: Checkout badtls
        uses: actions/checkout@v3
        with:
          repository: wbond/badtls.io
          path: ./badtls.io
      - name: Checkout badssl
        uses: actions/checkout@v3
        with:
          repository: chromium/badssl.com
          path: ./badssl.com
      - name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.rust_version }}
      - name: Build badssl.com
        shell: bash
        working-directory: badssl.com
        env:
          DOCKER_BUILDKIT: 1
        run: ../smithy-rs/tools/ci-scripts/configure-tls/configure-badssl
      - name: Build trytls
        shell: bash
        working-directory: trytls
        run: ../smithy-rs/tools/ci-scripts/configure-tls/configure-trytls
      - name: Build badtls.io
        working-directory: badtls.io
        shell: bash
        run: ../smithy-rs/tools/ci-scripts/configure-tls/configure-badtls
      - name: Create TLS stub
        shell: bash
        run: |
          cargo new stub
          cd stub
          cargo add rustls
          cargo add aws-config
          cargo add aws-sdk-sts
          cargo add tokio -F full
          cargo add rustls-pemfile
          cargo add exitcode
          cargo add rustls-native-certs
          cargo add x509-parser
          cargo add hyper-rustls -F 'rustls-native-certs,http2'
          cargo add aws-credential-types -F hardcoded-credentials
          cargo add aws-smithy-client -F rustls
          cp ../smithy-rs/tools/ci-resources/tls-stub.rs src/main.rs
      - name: Update TLS configuration
        shell: bash
        run: smithy-rs/tools/ci-scripts/configure-tls/update-certs
      - name: Test TLS configuration
        working-directory: stub
        shell: bash
        run: |
          cargo build
          trytls https target/debug/stub || true
