#!/bin/bash
#
# Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
# SPDX-License-Identifier: Apache-2.0
#

# this job runs `cargo check` only instead of `cargo test --all-features`

set -eux
cd aws-sdk

# Remove examples from workspace
sed -i '/"examples\//d' Cargo.toml

cargo check --all-targets --all-features

echo "## Checking the wasm32-unknown-unknown and wasm32-wasi targets for SDKs"
for dir in sdk/*; do
    if [[ "$(basename "${dir}")" == aws-sdk-* ]]; then
        echo "#### Checking ${dir}..."
        cargo check --target wasm32-unknown-unknown --no-default-features --manifest-path "${dir}/Cargo.toml"
        cargo check --target wasm32-wasi --no-default-features --manifest-path "${dir}/Cargo.toml"
    fi
done

for test_dir in tests/*; do
    if [ -f "${test_dir}/Cargo.toml" ]; then
        echo "#### Checking ${test_dir}..."
        cargo check --all-targets --all-features --manifest-path "${test_dir}/Cargo.toml"
    fi
done

large_file_count="$(find sdk -iname '*.rs' -type f -size +1M | wc -l | bc)"
if [[ "${large_file_count}" != "0" ]]; then
    echo "Found ${large_file_count} generated code files larger than 1 MB:"
    find sdk -iname '*.rs' -type f -size +1M
    exit 1
fi
