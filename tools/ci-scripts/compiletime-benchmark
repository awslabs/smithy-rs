#!/bin/bash
#
# Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
# SPDX-License-Identifier: Apache-2.0
#
C_YELLOW='\033[1;33m'
C_RESET='\033[0m'
set -x

cd smithy-rs
DIR=$PWD

function log_time() {
    rm /tmp/temp-log.txt && 
    touch /tmp/temp-log.txt &&
    { time "bash -c $1"; } &> /tmp/temp-log.txt &&
    cat /tmp/temp-log.txt 
    real_time=$(tail /tmp/temp-log.txt | grep real )
    echo $real_time >> /tmp/compiletime-benchmark.txt
}

function compile() {
    cd $1 &&
        export CARGORUSTFLAG="" &&
        cargo clean &&
        cargo build &>/dev/null && 
        cargo clean && # this is for downloading crates
        log_time "cargo build" &&
        cargo clean &&
        log_time "cargo build --release" &&
        cargo clean &&
        export CARGORUSTFLAG="--cfg aws_sdk_unstable" &&
        log_time "cargo build --all-features" &&
        cargo clean &&
        log_time "cargo build --release --all-features" &&
        cargo clean
}

./gradlew :aws:sdk:assemble

for variable in $(dir "aws/sdk/build/aws-sdk/sdk"); do
    if [[ $variable != *"aws-"* ]]; then
        echo "START" &>>/tmp/compiletime-benchmark.txt
        echo "$variable" &>>/tmp/compiletime-benchmark.txt
        compile "$DIR/aws/sdk/build/aws-sdk/sdk/$variable"
        echo "END" &>> /tmp/compiletime-benchmark.txt
    fi
done

echo /tmp/compiletime-benchmark.txt

cd $DIR
python3 tools/compiletime-benchmark/format.py
