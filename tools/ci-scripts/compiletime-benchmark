#!/bin/bash
#
# Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
# SPDX-License-Identifier: Apache-2.0
#
C_YELLOW='\033[1;33m'
C_RESET='\033[0m'
set -x

cd smithy-rs
DIR=$PWD
TMP_LOG="/tmp/temp-log.txt"
function log_time() {
    cargo clean
    echo "$1"
    touch $TMP_LOG
    { time $1 &>$TMP_LOG; } &> $TMP_LOG
    echo $(cat /tmp/temp-log.txt)
    real_time=$(tail $TMP_LOG | grep real)
    echo $real_time >> /tmp/compiletime-benchmark.txt
}

function compile() {
    cd $1 &&
        export CARGORUSTFLAG="" &&
        cargo build && # this is for downloading crates
        cargo clean &&
        log_time "cargo build" &&
        log_time "cargo build --release" &&
        export CARGORUSTFLAG="--cfg aws_sdk_unstable" &&
        log_time "cargo build --all-features" &&
        log_time "cargo build --release --all-features"
}

./gradlew :aws:sdk:assemble

for variable in $(dir "aws/sdk/build/aws-sdk/sdk"); do
    echo $variable
    if [[ $variable != *"aws-"* ]]; then
        echo "START" &>>/tmp/compiletime-benchmark.txt
        echo "$variable" &>>/tmp/compiletime-benchmark.txt
        compile "$DIR/aws/sdk/build/aws-sdk/sdk/$variable"
        echo "END" &>>/tmp/compiletime-benchmark.txt
    fi
done

echo /tmp/compiletime-benchmark.txt

cd $DIR
python3 tools/compiletime-benchmark/format.py
